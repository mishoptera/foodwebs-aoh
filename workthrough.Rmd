---
title: "foodwebs-eda"
author: "Misha Leong"
date: "1/10/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup environment

Load libraries and files to work with

```{r loadup}
# load libraries
library(tidyverse)
library(cooccur)

# load files
load('data/aoh.Rdata') # large 7roomsFamilies dataset from Bertone PeerJ paper
load('data/core.Rdata') # list of 47 core species from Leong Sci Reports paper

```

## Some basic stats

```{r basics, echo=FALSE}
head(aoh)
head(core)
aoh_core <- semi_join(aoh, core, by = "familyLong")
```


## Function to look for cooccurrence
```{r coreFunction}

i <- "basement"
room_data <- aoh_core %>% filter (roomType == i)

coo <- function (room_data, room) {
  # build a presence/absence matrix
  core_matrix <- room_data %>%
    group_by(roomUnique, familyLong) %>%
    summarise(obs = n()) %>%
    spread(familyLong, obs, fill = 0) %>%
    as.data.frame() 
  rownames(core_matrix) <-  core_matrix[,1]
  core_matrix <- core_matrix[, -1]
  core_matrix <- t(core_matrix) # transpose data frame
  
  # run cooccur program
  cooccur_room <- cooccur(mat = core_matrix, type = "spp_site", 
                          spp_names = TRUE, thresh = TRUE)
  summary(cooccur_room)
  plot(cooccur_room)
  
  # output the main relationships for each room
  # results table is filtered for significant pairwise observations where 
  # species are found occurring together greater than expected. For further 
  # explanation of results table see:
  # https://www.jstatsoft.org/article/view/v069c02/v69c02.pdf
  pos_pairs <- as.tibble(cooccur_room$results) %>% 
    arrange(p_gt) %>%
    filter(p_gt < 0.05)
  pos_pairs
  
  neg_pairs <- as.tibble(cooccur_room$results) %>% 
    arrange(p_lt) %>%
    filter(p_t < 0.05)
  neg_pairs
  
  
  
  
  room_rank = paste0(room, "_rank")
  room_count = paste0(room, "_count")
  
  room_taxa <- room_data %>%
    group_by(roomUnique) %>%
    summarise(count = n()) %>%
    arrange(desc(count)) %>%
    mutate(rank = rank(desc(count), ties.method="average")) %>%
    rename(!!city_rank := rank) %>%
    rename(!!city_count := count)
  
  return(city_taxa)
}

```
 Compare to cooccur
```{r}
#now run coccurrence!
library(cooccur)
setwd("~/Dropbox/AoH/dataMain/Useful")
aoh<-read.csv("cooccurPAgreaterThan10.csv")
cooccur.aoh<-cooccur(mat=aoh, type="site_spp", spp_names=TRUE, thresh=TRUE)
summary(cooccur.aoh)
plot(cooccur.aoh)
es<-effect.sizes(cooccur.aoh, standardized=TRUE,matrix=FALSE)
scuti<-pair(cooccur.aoh, "Scutigeromorpha..house.centipedes._Scutigeridae..house.centipedes.", all=FALSE)
scutiALL<-pair(cooccur.aoh, "Scutigeromorpha..house.centipedes._Scutigeridae..house.centipedes.", all=TRUE)
pair.profile(cooccur.aoh)
co<-pair.attributes(cooccur.aoh)
print(cooccur.aoh)
prob.table(cooccur.aoh)


zygen<-pair(cooccur.aoh, "Zygentoma..silverfish._Lepismatidae..silverfish.", all=FALSE)
zygenALL<-pair(cooccur.aoh, "Zygentoma..silverfish._Lepismatidae..silverfish.", all=TRUE)

write.csv(es, "es.csv")
write.csv(scuti, "scuti.csv")
write.csv(scutiALL, "scutiALL.csv")
write.csv(zygen, "zygen.csv")
write.csv(zygenALL, "zygenALL.csv")

data(finches)
cooccur.finches <- cooccur(mat=finches,
                           type="spp_site",
                           thresh=FALSE,
                           spp_names=TRUE)
effect.sizes(cooccur.finches,matrix=TRUE)




for(i in 1:10) {
  if(i %% 2 == 0)
    print(paste(i, "is even"))
}

```
 

```{r rooms}
room_names <- c("basement", "bath", "bed", "common", "kitchen", "attic")

# create simple ranking tables for each taxa (landcover collapsed)
lapply(room_names, function(i){
  assign(paste0("core_", i) , coo(aoh_core %>% filter (room == i), i), 
         envir = .GlobalEnv)
})

  
```
